clear 
close all
clc

%load 'kep2f.mat'
kep_p = [9.378936754923840E+03 1.465199422126562E-02 (2.778407641919647E+01)*pi/180 ...
        (8.300015291754670E+01)*pi/180 (1.042054831005449E+02)*pi/180 (1.931118051084441E+02)*pi/180];
OM = (4.948373766114121E+01)*pi/180;
w = 286.46*pi/180;
mu = astroConstants(14);
state = kep2car(kep_p,mu);
tilt = (25.19+1.85)*pi/180;
%state=[-1.467380446309271E+05, -3.732818830158730E+05, -3.651352304163795E+04,  9.121533106943928E-01, -3.306455276131604E-01, -1.240200596211512E-02];
Xe = state(1:3);
Ve = state(4:6);
R1 = [1      0           0     ;...
     0  cos(tilt)   sin(tilt);...
     0  -sin(tilt)   cos(tilt)];

R2 = [cos(OM) sin(OM)  0;...
     -sin(OM) cos(OM)  0;...
        0       0      1];
R3 = [cos(w) sin(w)  0;...
     -sin(w) cos(w)  0;...
        0       0      1];    
R = R3*R1*R2;    
 Xeq = R*Xe';
 Veq = R*Ve';
 
 state_eq = [Xeq;Veq];
 kep_eq = car2kep(state_eq',mu);
 
 %%
 options = odeset('Reltol',1e-13,'AbsTol',1e-14);

 s0 = [3.369131205256336E+03, -8.871364521911601E+03, -1.613136123066006E+02,  1.980197612092066E+00,  7.328828344894922E-01, -1.636832045191527E-02];
 s0 = [7.425049467288890E+03, -4.207615195864343E+03, -4.152443908377780E+03,  8.947057400411081E-01,  1.880779014657508E+00, -3.474761464006618E-01];
 kep0 = car2kep(s0,mu)
 [t,s]=ode113(@(t,y)dyn_2BP(t,y,mu),[0 8*3600*24],s0,options);

 figure()
 hold on 
 axis equal
 plot3(s(:,1), s(:,2), s(:,3))